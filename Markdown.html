<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HTML to Markdown Converter</title>
  <script src="https://unpkg.com/turndown@7.1.1/dist/turndown.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/3.0.8/marked.min.js"></script>
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/monokai.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js"></script>
  <style>
  .container {
    display: flex;
  }
  .input-section {
    margin-right: 20px;
  }
  #previewOutput {
    width: 100%;
    border: 1px solid #ccc;
    overflow: auto;
    resize: both;
    padding: 10px;
  }
  /* Add the following blockquote CSS */
  #previewOutput blockquote {
    border-left: 4px solid #ccc;
    padding-left: 1em;
    margin: 1em 0;
  }
  #previewOutput table {
    border-collapse: collapse;
    border-spacing: 0;
    width: 100%;
    margin-bottom: 1em;
  }
  #previewOutput table th,
  #previewOutput table td {
    border: 1px solid #ccc;
    padding: 6px 13px;
    text-align: left;
  }
  #previewOutput table th {
    font-weight: bold;
  }
  /* Updated CSS rule for inline code elements */
  #previewOutput :not(pre) > code {
    background-color: #f0f0f0;
    padding: 2px 4px;
    border-radius: 3px;
  }
  </style>
</head>
<body>
  <h2>HTML to Markdown Converter</h2>
  <div class="container">
    <div class="input-section">
      <textarea id="htmlInput" rows="10" cols="80" placeholder="Enter your HTML code here"></textarea>
      <br>
      <button id="convertButton">Convert</button>
      <button id="previewButton">Preview</button>
      <br>
      <textarea id="markdownOutput" rows="10" cols="80" placeholder="Markdown input-output"></textarea>
      <br>
      <textarea id="plainTextOutput" rows="10" cols="80" placeholder="Plain text output will appear here"></textarea>
    </div>
    <div id="previewOutput" rows="33" cols="80"></div>
  </div>

  <script>
    function convertHtmlToMarkdown() {
      var htmlInput = document.getElementById('htmlInput').value;
      var turndownService = new window.TurndownService();

      turndownService.keep(function(node) {
        return node.style.fontStyle === 'italic' || node.style.fontWeight >= 600 || node.style.textDecoration === 'line-through';
      });

      turndownService.addRule('customStyles', {
        filter: ['span'],
        replacement: function(content, node) {
          var fontStyle = node.style.fontStyle;
          var fontWeight = node.style.fontWeight;
          var textDecoration = node.style.textDecoration;

          if (fontStyle === 'italic') {
            return '_' + content + '_';
          } else if (fontWeight >= 600) {
            return '**' + content + '**';
          } else if (textDecoration === 'line-through') {
            return '~~' + content + '~~';
          } else {
            return content;
          }
        }
      });

      // Custom rules for tables and blockquotes
      turndownService.addRule('tables', {
        filter: ['table', 'thead', 'tbody', 'tfoot', 'tr', 'th', 'td'],
        replacement: function(content, node) {
          if (node.nodeName === 'TABLE') {
            return '\n\n' + content + '\n\n';
          } else if (node.nodeName === 'THEAD' || node.nodeName === 'TBODY' || node.nodeName === 'TFOOT') {
            return content;
          } else if (node.nodeName === 'TR') {
            return content + '\n';
          } else if (node.nodeName === 'TH' || node.nodeName === 'TD') {
            return '|' + content;
          }
        }
      });

      turndownService.addRule('blockquotes', {
        filter: 'blockquote',
        replacement: function(content) {
          return '> ' + content;
        }
      });

      var markdown = turndownService.turndown(htmlInput);
      document.getElementById('markdownOutput').value = markdown;
    }

    function showMarkdownPreview() {
      var markdownInput = document.getElementById('markdownOutput').value;

      // Customize the marked renderer to include the language class in the <code> tags
      var renderer = new marked.Renderer();
      renderer.code = function(code, language) {
        return '<pre><code class="' + language + '">' + code + '</code></pre>';
      };

      // Enable GitHub Flavored Markdown and table support
      marked.setOptions({
        gfm: true,
        tables: true,
        renderer: renderer
      });

      var htmlOutput = marked(markdownInput);
      var previewOutput = document.getElementById('previewOutput');
      previewOutput.innerHTML = htmlOutput;

      // Highlight code blocks in the previewOutput div
      previewOutput.querySelectorAll('pre code').forEach((block) => {
        hljs.highlightElement(block);
      });

      // Update plain text output
      var plainTextOutput = document.getElementById('plainTextOutput');
      plainTextOutput.value = previewOutput.innerText;
    }

    document.getElementById('convertButton').addEventListener('click', convertHtmlToMarkdown);
    document.getElementById('previewButton').addEventListener('click', showMarkdownPreview);
  </script>
</body>
</html>